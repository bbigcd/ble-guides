# iOS BLE MTU sizes 逆向工程推理 

从 iOS10 开始, ATT MTU 的协商大小是 185 字节, 之前是 158 字节. 虽然这些数字可能一开始看起来是随机的，但继续读下去，你就会明白它们实际上是多么聪明!

# 协商 ATT MTU 大小时要考虑的因素

不同的 BLE 设备支持不同的 ATT MTU 大小. 较大的 MTU 大小减少了相对的数据包开销，有助于获得更高的[吞吐量](https://github.com/bbigcd/ble-guides/blob/master/ble-throughput.md)

然而, 在协商 MTU 大小时，还应该考虑其他一些因素:

* **最小延迟** - 当使用 BLE 时, 数据传输从称为*连接事件*的同步点开始, 在一个*连接事件*期间, 给定的 BLE 设备可以发送的数据量是取决于供应商的. 对于大型 MTU，可能需要多个连接事件来传输一个MTU值的数据。根据*连接事件*的频率(7.5ms - 4), 这可能意味着在对等设备接收到一个MTU的所有数据之前有相当大的延迟
* **最优装包** - ATT 消息在链路层(LL)包上传输. LL 包可以保持27字节的最大数据有效载荷. 在理想情况下, 我们希望选择一个 MTU 大小, 以便数据能够完美的匹配这些27字节的数据有效负载. 否则, 会牺牲一些吞吐量, 因为由于数据字段较小, 最终的LL包会有更多的开销.

# 为什么 iOS10 使用 185 byte MTU?!

你可以能会记得, 当传输一个 ATT MTU 值的数据时，在LL数据有效载荷中有一个占用4字节的 L2CAP 报头. 因此, 传输一个185字节的 ATT MTU 将需要189字节的链路层有效负载. 这意味着我们需要 `189/27 = 7` LL 包.

如果你 airtrace 的是一个 iOS 10 的设备, 你会发现在*连接事件*期间发送的数据包的最大数量将是7!

如果你对低于 iOS 10对旧设备MTU 大小为 158 运行同样的分析, 您将发现结果正好是6个LL包。airtrace还会确认这是*连接事件*期间发送的数据包的最大数量


# 关于 Android?

Android 允许用户执行最多512字节的 MTU 交换(即使许多 Android 手机只支持23字节 MTU :smile:)。对于给定的用例，应该由开发人员来考虑最佳的 MTU 大小。