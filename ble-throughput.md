# 理解&优化 BLE 的吞吐量

这篇文章着重说明在使用 GATT 过程中控制 BLE 吞吐量的因素,  你会需要把它调到最大程度.

当我试图去了解 BLE 的吞吐量时, 我因为缺少关于这个主题的文章而感到沮丧... 这就是我写这篇文章的目的!

如果你正在试图去提高你的 BLE 应用的吞吐量, 或者仅仅为了了解更多关于 BLE 通用协议栈的内容, 请继续阅读!

# 术语

在我们开始之前, 我们需要去了解一些基本的术语.

* **连接事件** - 对于 BLE, 两个设备在一次连接中彼此进行通讯. 即使没有数据交互, 彼此必须定期 ping 对方, 以确保*连接*仍然活着. 每一次设备之间的彼此 ping 对方的过程被称为*连接事件*
* **连接间隔** - 每个*连接事件*之间的间隔时间(有效区间为7.5ms到4秒). 当两个设备连接好之后, *连接间隔*可以进行协商.为了优化功耗, 动态的改变*连接间隔*通常是有效的.

# 理解 LE 包层

为了优化吞吐量, 第一件事就是要查看蓝牙的 LE 包的组成.

## 蓝牙 基带 / 无线电

蓝牙无线电每微秒能传输一个符号(比特率为1兆/秒), 然而这并不是真正的吞吐量, 原因如下:

1. 在每个发送的数据包之间必须有一个强制性的*150μs* *延迟(称为*帧空间(T_IFS))
2. BLE 是一种*可靠性传输*, 意味着从一方发送的每个数据包都必须被另一方确认(ACK).一个 ACK 包的大小是80 bits, 因此需要 *80μs* 来传输.
3. 最大的数据包为 41bytes(328 bits), 因此需要 328μs 来传输.

### 数据交换示例

![Data exchange](ble_throughput_pics/connection_event.png)


## 链路层包(LL)

这是通过空中发送数据使用的格式.所有更高级别的消息被打包在*数据有效负载* 的 *LL 包* 中 . 下面是 LL 包的格式:

![Data exchange](ble_throughput_pics/ll_packet.png)

### 最大的LL数据有效负载吞吐量

交换一个数据包涉及:

* A 端发送一个最大的LL数据包(27 bytes大小的数据)
* B 端接受这个LL数据包并等待 T_IFS (*150μs*)
* B 端发送一个 ACK LL 包(0 bytes 大小)
* A 端等待 T_IFS 然后可以停止发送或传输更多的数据

根据上面的讨论，可以计算出该序列所花费的时间:

`328μs data packet + 150μs T_IFS + 80μs ACK + 150μs T_IFS = 708μs`

在此期间，实际数据可传输27字节，用时216μs。

这产生一个数据吞吐量:

`(216μs / 708μs) * 1Mbit/sec = 305,084 bits/second = 38.1kBytes/s`

## L2CAP 通道&有效载荷

L2CAP 是更高级的协议，封装在LL包的**数据有效负载**中。L2CAP 允许:

* 在不同的虚拟通道上复用不相关的数据流
* 跨多个LL包分段和反分段数据(因为一个L2CAP有效负载可以跨多个LL包)

只有几个不同的 L2CAP 频道用于 LE:

1. **安全管理器协议(SMP)** -用于BLE安全设置
2. **属性协议(ATT)** - Android和iOS都提供api，允许第三方应用程序通过该通道控制传输。
3. **LE L2CAP面向连接的通道** - 自定义通道，对流媒体应用程序非常有利。然而，目前在移动平台上还没有第三方api，所以它在实践中并不是很有用.

### L2CAP 包

![Data exchange](ble_throughput_pics/l2cap_packet.png)

## 属性协议(ATT)包

在 *L2CAP 信息负载* 中我们有 ATT 包. 这个包的结构是*GATT*协议的封装，BLE设备使用它来彼此交换数据. 它看起阿里是这样的:

![Data exchange](ble_throughput_pics/att_packet.png)

### GATT 协议最高吞吐量

属性协议处理值通知是服务端向客户端传送数据的最佳方式.这个操作的操作码开销是 2 字节. 这意味着每个 ATT 有效载荷有3个字节的 ATT 数据包开销和4个字节的 L2CAP 开销. 我们可以通过取最大 LL 吞吐量并将其乘以ATT数据包的效率来确定最大 ATT 吞吐量:

`ATT Throughput = LL throughput * ((MTU Size - ATT Overhead) / (L2CAP overhead + MTU Size))`

#### 按 ATT MTU 大小可实现的最大吞吐量
MTU size (bytes)         | Throughput (kBytes/sec) |
-------------            | -------------           |
23 (default)             |  28.2                   |
185 (iOS 10 max)         |  36.7                   |
512 (bluetooth max)      |  37.6                   |

### GATT 的实际吞吐量

在实践中, 可以实现的吞吐量进一步受到所使用的设备的限制. 一些常见的因素有:

* 在一次*连接事件*中可以传输的数据包的数量. 一个完整的连接事件可以被数据填充，但是很多设备每个事件只传输几个数据包。
* 对于每*连接事件*只发送几个包的设备，它们尝试将*连接间隔*变得非常短，以便经常发送数据. 然而，设备通常只支持7.5ms - 4s范围的一部分。
* 设备支持的最大 MTU 大小(Android 设备中很多 BT 芯片在大于默认值23时会删除数据)
* BT LE, BT Classic和Wifi使用相同的天线 / 芯片 / 调度器, 因此, wifi/经典流量的爆发可以减少每个*连接事件*发送的 LE 数据包的数量

Below I'll walk through two practical phone examples and their peak *GATT* throughput. Do note that often a developer will add another protocol on top of *GATT* to stream data. The scheme chosen can also have a significant impact on the throughput.

下面我将通过两个实际的手机来展示他们的最大吞吐量。请注意，通常开发人员会在 *GATT* 层之上的协议来进行流数据通信. 选择的方案也会对吞吐量产生重大影响.

#### 例子 1 - iOS 10 / iPhoneSE

##### 背景
对于小于 iOS10 的设备, 每个连接间隔传输约4~6个数据包, 支持的最大MTU大小为158字节. 对于 iOS10 以上的设备, 现在支持 185 字节的 MTU 和每个连接间隔传输7个数据包.

当你使用 iOS 连接一个 BLE 设备, 它将以 30 ms 的连接间隔开始(如果设备支持 HID over GATT, 这个值会是: 11.25 ms). 然而, 一但连接, 它可能会协商到15ms的间隔. 请注意, 根据设备能够传输的数据包的数量, 较低的连接间隔可能并不会影响性能, 因为设备可以用数据包在更大的*连接间隔*中填满所有空间.

##### 最大吞吐量
下面连接间隔为15毫秒, ATT MTU 大小为 185 字节, 每个*连接间隔*被传输和确认的7个数据包

First let's make sure we can transmit 7 packets in 15ms:

首先, 让我们确保我们能在 15 毫秒内传输7 个数据包:

` 7 * (328μs Data + 150μs + 80μs ACK + 150μs) = 4.956ms`

现在我们知道数据包是合适的, 我们可以用我们正在实现的占空比乘以上面表中 ATT 吞吐量的最大值。

`Data Rate = (4.956ms / 15ms) * 36.7 kBytes/Sec = 12.2 kBytes/sec`

#### 例子 2 - Nexus 5x

迄今为止, Nexus 5x 是我见过拥有性能最好的BLE芯片之一. 它会用数据包填充整个*连接间隔*事件, 并支持512字节的 MTU 大小. 在 15ms 的连接间隔, 我甚至看到传输了多达21个数据包. 这需要:

`21 * (328μs Data + 150μs + 80μs ACK + 150μs) = 14.868ms`

不过, 这似乎太疯狂了, 芯片经常在随后的连接事件中跳过传输任何数据, 从而有效的将占空比减半. 不过, 这仍然产生了令人意想不到的吞吐量:

`Data Rate = (14.868ms / 30ms) * 37.6 kBytes/sec = 18.6 kBytes/sec`

*全面披露*: Android BLE生态系统*非常*多样化，虽然有些设备性能很好，但有些设备性能却很差。我什至看到有些 Android 设备每个连接间隔只能发送1个数据包！

# 其他主题...即将推出

* 蓝牙 4.2 数据包长度扩展(从BT 4.2开始，LL数据包数据有效载荷最多可协商255个字节！)
* 查看哪个设备闲置了吞吐量
* 处理手机和供应商中BLE bugs (大量)

